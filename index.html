<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Arbeitszeit V57">
    <title>Arbeitszeit Tracker V57</title>

    <style>
        :root {
            --bg: #000000;
            --card: #1c1c1e;
            --card-border: #2c2c2e;
            --text: #ffffff;
            --text-sub: #8e8e93;
            --input: #1c1c1e;
            --accent: #0A84FF;
            --btn-active: #3a3a3c;
            
            /* Farben */
            --c-urlaub: #FF9F0A; 
            --c-stunden: #0A84FF;
            --c-krank: #FF453A;
            --c-da: #BF5AF2;
            --c-lzk: #30D158;
            --c-sonder: #64D2FF;
            --c-holiday: #30D158;
        }

        body { font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", Helvetica, Arial, sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; font-size: 14px; }
        
        header { padding-top: max(10px, env(safe-area-inset-top)); padding-bottom: 10px; background-color: var(--bg); border-bottom: 1px solid var(--card-border); z-index: 100; position: relative; display: flex; justify-content: center; align-items: center; }
        header h1 { margin: 0; font-size: 16px; font-weight: 600; color: var(--text-sub); text-transform: uppercase; letter-spacing: 1px; }
        #header-reset-btn { position: absolute; right: 15px; background: none; border: none; font-size: 18px; cursor: pointer; display: none; }

        main { flex: 1; overflow-y: auto; padding: 15px; padding-bottom: 90px; }

        /* INPUT STYLES */
        .input-row { display: flex; gap: 10px; margin-bottom: 12px; }
        .input-col { flex: 1; min-width: 0; }
        label { display: block; color: var(--text-sub); font-size: 11px; margin-bottom: 5px; text-transform: uppercase; }
        input, select, textarea { width: 100%; height: 45px; background-color: var(--input); border: 1px solid var(--card-border); color: white; padding: 10px; border-radius: 8px; font-size: 16px; box-sizing: border-box; -webkit-appearance: none; font-family: inherit; }
        textarea { resize: none; height: 70px; }
        .btn { width: 100%; padding: 14px; border-radius: 8px; border: none; font-size: 16px; font-weight: 600; cursor: pointer; margin-top: 5px; }
        .btn-primary { background-color: var(--card-border); color: var(--accent); }
        .btn-list-view { width: 100%; padding: 10px; background: var(--accent); color: white; border: none; border-radius: 8px; font-size: 13px; font-weight: 600; margin-bottom: 10px; cursor: pointer; }

        .hidden { display: none !important; }

        /* LIST ITEMS */
        .history-item, .list-view-item, .upcoming-item { background-color: var(--card); padding: 10px 12px; border-radius: 8px; margin-bottom: 6px; border-left: 4px solid #555; position: relative; display: flex; justify-content: space-between; align-items: center; }
        .cat-urlaub { border-left-color: var(--c-urlaub); }
        .cat-stunden { border-left-color: var(--c-stunden); }
        .cat-krank { border-left-color: var(--c-krank); }
        .cat-da { border-left-color: var(--c-da); }
        .cat-lzk { border-left-color: var(--c-lzk); }
        .cat-sonder { border-left-color: var(--c-sonder); }
        
        .h-content, .lv-info { flex: 1; min-width: 0; }
        .h-top { display: flex; justify-content: space-between; align-items: flex-start; }
        .h-title, .lv-title { font-size: 14px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .h-meta, .lv-meta, .u-meta { font-size: 11px; color: var(--text-sub); margin-top: 2px;}
        .h-val { font-size: 14px; font-weight: 700; text-align: right; margin-right: 10px; white-space: nowrap;}
        .h-val.neg { color: #ff453a; }
        .h-val.pos { color: #30d158; }
        .h-btn-group { display: flex; gap: 10px; align-items: center; z-index: 10; position: relative; }
        .h-action-btn { background: #2c2c2e; border: 1px solid #444; color: white; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; cursor: pointer; }

        /* KALENDER HEADER */
        #cal-sticky-header { position: sticky; top: -15px; background-color: var(--bg); z-index: 50; padding-top: 15px; padding-bottom: 5px; margin-bottom: 10px; border-bottom: 1px solid var(--card-border); }
        .year-selector { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; font-size: 18px; font-weight: bold; }
        .year-btn { background: none; border: none; color: var(--accent); font-size: 24px; cursor: pointer; padding: 0 20px; }
        
        /* FILTER */
        .filter-wrapper { position: relative; display: inline-block; }
        .filter-toggle-btn { background: var(--card); border: 1px solid var(--card-border); color: var(--text-sub); padding: 6px 15px; border-radius: 15px; font-size: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 5px; }
        .filter-toggle-btn.active { color: var(--accent); border-color: var(--accent); }
        .filter-dropdown-menu { position: absolute; top: 35px; right: 0; background: #2c2c2e; border: 1px solid #444; border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); z-index: 200; display: none; flex-direction: column; min-width: 160px; max-height: 300px; overflow-y: auto; }
        .filter-dropdown-menu.show { display: flex; }
        .filter-option { padding: 12px 15px; color: #ddd; font-size: 13px; cursor: pointer; border-bottom: 1px solid #3a3a3c; }
        .filter-option:last-child { border-bottom: none; }
        .filter-option.selected { color: var(--accent); font-weight: bold; }

        /* KALENDER GRID - NEUES DESIGN */
        .calendar-grid { display: grid; grid-template-columns: 1fr; gap: 20px; }
        @media (orientation: landscape) { .calendar-grid { grid-template-columns: 1fr 1fr 1fr; } }
        .month-card { background-color: var(--card); padding: 5px; border-radius: 8px; border: 1px solid var(--card-border); scroll-margin-top: 150px; }
        .month-name { text-align: center; font-weight: 700; margin: 8px 0; color: var(--text-sub); text-transform: uppercase; font-size: 13px; }
        .days-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; text-align: center; }
        .day-label { font-size: 9px; color: #555; padding-bottom: 5px; }
        
        .day-cell { 
            aspect-ratio: 1; 
            display: flex; 
            flex-direction: column; 
            /* √ÑNDERUNG: Start oben statt space-between */
            justify-content: flex-start; 
            align-items: center; 
            font-size: 12px; 
            border-radius: 4px; 
            position: relative; 
            cursor: pointer; 
            background: rgba(255,255,255,0.03); 
            overflow: hidden; 
            /* √ÑNDERUNG: Kleiner Abstand oben */
            padding-top: 4px; 
        }
        
        .day-cell.is-holiday span { color: var(--c-holiday) !important; font-weight: 900 !important; text-shadow: 0 0 5px rgba(48, 209, 88, 0.3); }
        
        .event-dots { 
            display: flex; 
            justify-content: center; 
            align-items: flex-end; 
            flex-wrap: wrap; 
            gap: 1px; 
            width: 100%; 
            /* √ÑNDERUNG: Punkte nach unten dr√ºcken */
            margin-top: auto;
            padding-bottom: 3px; 
        }
        .event-icon { font-size: 9px; line-height: 1; text-shadow: 0 0 2px black;}
        .event-dot { width: 5px; height: 5px; border-radius: 50%; background-color: #555; }

        /* HEUTE MARKIERUNG - 35% WEISS - ZAHL OBEN */
        .day-cell.is-today {
            /* Hintergrund: Oben 35% Wei√ü, Rest transparent/dunkel */
            background: linear-gradient(to bottom, #ffffff 35%, rgba(255,255,255,0.03) 35%) !important;
            border: 1px solid #888;
        }
        .day-cell.is-today > span {
            color: #000000 !important; /* Zahl Schwarz */
            font-weight: 900 !important;
        }

        /* DASHBOARD STYLES (HOME) */
        .dashboard-card { background: var(--card); padding: 20px; border-radius: 16px; border: 1px solid var(--card-border); margin-bottom: 15px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .dash-label { color: var(--text-sub); font-size: 11px; text-transform: uppercase; margin-bottom: 10px; letter-spacing: 1px; }
        .dash-title { font-size: 28px; font-weight: 800; color: var(--accent); margin-bottom: 5px; line-height: 1.2; }
        .dash-date { font-size: 16px; color: white; margin-bottom: 5px; font-weight: 600; }
        .dash-time { font-size: 14px; color: #ccc; margin-bottom: 15px; }
        .dash-note { font-size: 13px; color: #888; font-style: italic; background: rgba(255,255,255,0.05); padding: 8px; border-radius: 8px; display: inline-block; max-width: 100%; }
        .dash-empty { color: #555; font-size: 16px; padding: 30px 0; }
        
        /* MODALS */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); z-index: 1000; display: none; justify-content: center; align-items: center; }
        .modal-overlay.open { display: flex; }
        .modal-content { background: #1c1c1e; width: 90%; max-width: 380px; padding: 20px; border-radius: 18px; border: 1px solid #333; box-shadow: 0 20px 40px rgba(0,0,0,0.6); max-height: 85vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid #333; }
        .modal-title { font-size: 17px; font-weight: 700; }
        .close-btn { background: none; border: none; font-size: 28px; color: #888; cursor: pointer; line-height: 1; }
        
        /* REMINDER */
        .reminder-box { text-align: center; padding: 10px 0; }
        .reminder-icon { font-size: 40px; margin-bottom: 10px; display: block; }
        .reminder-text { font-size: 16px; margin-bottom: 20px; line-height: 1.4; }
        .reminder-date { font-size: 12px; color: #888; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 1px; }
        .reminder-actions { display: flex; gap: 10px; }
        .btn-rem-yes { background: var(--accent); color: white; flex: 1; padding: 12px; border: none; border-radius: 8px; font-weight: bold; font-size: 14px; }
        .btn-rem-no { background: #333; color: #aaa; flex: 1; padding: 12px; border: none; border-radius: 8px; font-weight: bold; font-size: 14px; }

        /* CATEGORY GRID & STATS */
        .category-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 20px; }
        .cat-btn { background: #2c2c2e; border: 1px solid transparent; color: #ddd; padding: 12px 5px; border-radius: 10px; font-size: 10px; text-align: center; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 6px; transition: all 0.15s; }
        .cat-btn:active { transform: scale(0.95); background: #3a3a3c; }
        .cat-btn.active { background: #3a3a3c; border: 2px solid var(--accent); color: white; box-shadow: 0 0 8px rgba(10,132,255,0.4); }
        .cat-btn-icon { font-size: 20px; margin-bottom: 2px; }

        .lv-icon, .u-icon { font-size: 16px; width: 20px; text-align: center; margin-right: 8px; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; margin-bottom: 10px;}
        .stat-box { background-color: var(--card); padding: 8px 5px; border-radius: 8px; border: 1px solid var(--card-border); position: relative; cursor: pointer; text-align: center;}
        .stat-box h4 { margin: 0 0 2px; font-size: 9px; color: var(--text-sub); text-transform: uppercase; }
        .stat-box span { font-size: 15px; font-weight: 700; color: var(--text); }
        .unit { font-size: 9px; color: var(--text-sub); font-weight: 400; margin-left: 1px; }
        .edit-icon { position: absolute; top: 2px; right: 2px; font-size: 10px; opacity: 0.3; }
        .stat-box.summary { grid-column: span 3; display: flex; justify-content: space-around; align-items: center; padding: 8px 10px; background: #2c2c2e; border-color: #555; cursor: default; }
        .stat-box.summary div { display: flex; flex-direction: column; align-items: center; }
        .stat-box.full-width { grid-column: span 3; padding: 8px; cursor: default; text-align: left;}

        /* TOOLS */
        .data-tools { margin-top: 10px; padding-top: 15px; border-top: 1px solid var(--card-border); display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .btn-settings-big { grid-column: span 2; background: #2c2c2e; border: 1px solid #555; color: white; padding: 15px; border-radius: 12px; font-size: 14px; font-weight: 600; cursor: pointer; text-align: center; }
        .btn-tool { padding: 10px; background: var(--card); border: 1px solid var(--card-border); color: var(--text); border-radius: 8px; font-size: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; }
        
        .settings-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 13px; }
        .settings-table td { padding: 5px; }
        
        .rem-config-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #333; }
        .rem-config-label { flex: 1; font-size: 13px; }
        .rem-config-inputs { display: flex; align-items: center; gap: 8px; }
        .rem-days-input { width: 50px; text-align: center; padding: 5px; border-radius: 5px; border: 1px solid #444; background: #1c1c1e; color: white; }
        
        .toggle-switch { position: relative; display: inline-block; width: 40px; height: 24px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #444; transition: .4s; border-radius: 24px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--accent); }
        input:checked + .slider:before { transform: translateX(16px); }

        nav { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.95); border-top: 1px solid #333; display: flex; height: 50px; padding-bottom: env(safe-area-inset-bottom); z-index: 500; }
        .nav-item { flex: 1; display: flex; justify-content: center; align-items: center; color: #666; font-size: 14px; flex-direction: column; gap: 3px; padding-top: 5px; transition: color 0.2s; }
        .nav-item span { font-size: 20px; }
        .nav-item div { font-size: 10px; font-weight: 600; }
        .nav-item.active { color: var(--accent); }
        .view { display: none; } .view.active { display: block; }
    </style>
</head>
<body>

    <header>
        <h1 id="header-title">Start</h1>
        <button id="header-reset-btn" onclick="resetAll()">üóëÔ∏è</button>
    </header>

    <main>
        <div id="view-home" class="view active">
            <div class="dashboard-card">
                <div class="dash-label">Als N√§chstes</div>
                <div id="dash-next-content">
                    </div>
            </div>
            
            <div style="text-align:center; margin-top:30px; color:#555; font-size:12px;">
                Einen sch√∂nen Tag!
            </div>
        </div>

        <div id="view-input" class="view">
            <div style="margin-bottom:20px; color:#0A84FF; font-size:16px; font-weight:bold; text-align:center; padding-bottom:10px; border-bottom:1px solid #333;">
                ‚è∞ Stunden gutschreiben
            </div>
            <div class="input-row">
                <div class="input-col"><label>Vom Tag</label><input type="date" id="date-start-time"></div>
                <div class="input-col"><label>Bis Tag</label><input type="date" id="date-end-time"></div>
            </div>
            <div class="input-row">
                <div class="input-col"><label>Von Uhrzeit</label><input type="time" id="time-start" value="00:00"></div>
                <div class="input-col"><label>Bis Uhrzeit</label><input type="time" id="time-end" value="00:00"></div>
            </div>
            <div class="input-row">
                <div class="input-col"><label>Anzahl Stunden (Manuell)</label><input type="number" id="hours-manual-val" step="0.1" placeholder="z.B. 8 oder 0"></div>
            </div>
            <div class="input-row"><div class="input-col"><label>Notiz</label><textarea id="inp-note" placeholder="Beschreibung..."></textarea></div></div>
            <button class="btn btn-primary" id="btn-save-main" onclick="saveEntry()">Buchen</button>
            <div id="edit-mode-hint" style="display:none; text-align:center; color:var(--accent); margin-top:10px; font-size:12px;">Modus: Eintrag bearbeiten</div>
        </div>

        <div id="view-calendar" class="view">
            <div id="cal-sticky-header">
                <div class="year-selector">
                    <button class="year-btn" onclick="changeYear(-1)">‚Äπ</button>
                    <span id="calendar-year-display">2026</span>
                    <button class="year-btn" onclick="changeYear(1)">‚Ä∫</button>
                </div>
                
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                     <button class="btn-list-view" style="width:auto; margin:0; padding:6px 12px;" onclick="openListModal()">üìã Liste</button>
                     
                     <div class="filter-wrapper">
                         <div class="filter-toggle-btn" onclick="toggleFilterMenu()" id="filter-btn-label">
                             Filter: Alle <span>‚ñæ</span>
                         </div>
                         <div class="filter-dropdown-menu" id="filter-menu">
                             <div class="filter-option selected" onclick="applyFilter('all', 'Alle')">Alle</div>
                             <div class="filter-option" onclick="applyFilter('Dienst', 'ü™ñ Dienst')">ü™ñ Dienst</div>
                             <div class="filter-option" onclick="applyFilter('Holiday', 'Feiertage & Ferien')">Feiertage & Ferien</div>
                             <div class="filter-option" onclick="applyFilter('Urlaub', 'Urlaub')">Urlaub</div>
                             <div class="filter-option" onclick="applyFilter('Kindkonto', 'Kindkonto')">Kindkonto</div>
                             <div class="filter-option" onclick="applyFilter('StundenTaken', 'Stunden (Genommen)')">Stunden (Genommen)</div>
                             <div class="filter-option" onclick="applyFilter('StundenEarned', 'Stunden (Bekommen)')">Stunden (Bekommen)</div>
                             <div class="filter-option" onclick="applyFilter('√úbungsplatz', '√úbungspl. (Blau)')">√úbungspl. (Blau)</div>
                             <div class="filter-option" onclick="applyFilter('√úbungsplatz Gr√ºn', '√úbungspl. (Gr√ºn)')">√úbungspl. (Gr√ºn)</div>
                             <div class="filter-option" onclick="applyFilter('Arzttermin', 'Arzt')">Arzt</div>
                             <div class="filter-option" onclick="applyFilter('Ausbildung', 'Ausbildung')">Ausbildung</div>
                             <div class="filter-option" onclick="applyFilter('UvD', 'UvD')">UvD</div>
                             <div class="filter-option" onclick="applyFilter('UvD Standort', 'UvD Standort')">UvD Standort</div>
                             <div class="filter-option" onclick="applyFilter('KvD', 'KvD')">KvD</div>
                             <div class="filter-option" onclick="applyFilter('DA', 'DA')">DA</div>
                             <div class="filter-option" onclick="applyFilter('Langzeitkonto', 'LZK')">LZK</div>
                             <div class="filter-option" onclick="applyFilter('Sonderurlaub', 'Sonderurlaub')">Sonderurlaub</div>
                             <div class="filter-option" onclick="applyFilter('Kindkrank', 'Kindkrank')">Kindkrank</div>
                             <div class="filter-option" onclick="applyFilter('Sonstiges', 'Sonstiges')">Sonstiges</div>
                         </div>
                     </div>
                </div>
            </div>
            <div class="calendar-grid" id="calendar-root"></div>
            <div style="height: 50px;"></div>
        </div>

        <div id="view-history" class="view">
            <div id="history-list"></div>
            <p id="no-data-msg" style="text-align:center; color:#333; margin-top:30px; display:none;">Keine Eintr√§ge.</p>
        </div>

        <div id="view-stats" class="view">
            <div class="stats-grid" id="stats-grid"></div>
            <div class="data-tools">
                <button class="btn-settings-big" onclick="openSettings()">‚öôÔ∏è Einstellungen / Erinnerungen</button>
                <button class="btn-tool" onclick="exportData()">üíæ Backup</button>
                <button class="btn-tool" onclick="document.getElementById('file-upload').click()">üìÇ Laden</button>
                <input type="file" id="file-upload" accept=".json" style="display:none" onchange="importData(this)">
            </div>
        </div>
    </main>

    <div id="reminder-modal" class="modal-overlay">
        <div class="modal-content" style="max-width:300px;">
            <div class="modal-header" style="border:none; margin-bottom:0;">
                <div class="modal-title">Erinnerung</div>
            </div>
            <div class="reminder-box">
                <span class="reminder-icon" id="rem-icon">üîî</span>
                <div class="reminder-date" id="rem-date"></div>
                <div class="reminder-text" id="rem-text"></div>
                <div class="reminder-actions">
                    <button class="btn-rem-no" onclick="handleReminder(false)">Sp√§ter</button>
                    <button class="btn-rem-yes" onclick="handleReminder(true)">Ja / Erledigt</button>
                </div>
            </div>
        </div>
    </div>

    <div id="list-view-modal" class="modal-overlay" onclick="closeListView(event)">
        <div class="modal-content">
            <div class="modal-header"><div class="modal-title">Kommende Termine</div><button class="close-btn" onclick="document.getElementById('list-view-modal').classList.remove('open')">√ó</button></div>
            <div style="font-size:12px; color:#666; padding:0 10px 10px; border-bottom:1px solid #333;" id="list-view-subtitle"></div>
            <div id="list-view-body" style="padding-bottom:10px;"></div>
        </div>
    </div>

    <div id="day-modal" class="modal-overlay" onclick="closeModal(event)">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modal-date-title"></div>
                <button class="close-btn" onclick="closeModalDirect()">√ó</button>
            </div>
            <div id="modal-body" style="margin-bottom:15px; border-bottom:1px solid #333; padding-bottom:10px;"></div>
            <div class="modal-add-title" style="margin-bottom:10px;">Neuer Eintrag</div>
            <div class="category-grid">
                <div class="cat-btn" data-cat="√úbungsplatz" onclick="selectModalCat(this, '√úbungsplatz', 'üîß', 'note')"><span class="cat-btn-icon">üîß</span>√úbungspl. B</div>
                <div class="cat-btn" data-cat="√úbungsplatz Gr√ºn" onclick="selectModalCat(this, '√úbungsplatz Gr√ºn', 'üå≥', 'note')"><span class="cat-btn-icon">üå≥</span>√úbungspl. G</div>
                
                <div class="cat-btn" data-cat="Arzttermin" onclick="selectModalCat(this, 'Arzttermin', 'üíâ', 'note')"><span class="cat-btn-icon">üíâ</span>Arzt</div>
                <div class="cat-btn" data-cat="Stunden" onclick="selectModalCat(this, 'Stunden', '‚è∞', 'taken')"><span class="cat-btn-icon">‚è∞</span>Stunden</div>
                
                <div class="cat-btn" data-cat="Urlaub" onclick="selectModalCat(this, 'Urlaub', 'üèñÔ∏è', 'taken')"><span class="cat-btn-icon">üèñÔ∏è</span>Urlaub</div>
                <div class="cat-btn" data-cat="Kindkonto" onclick="selectModalCat(this, 'Kindkonto', 'üèñÔ∏è', 'taken')"><span class="cat-btn-icon">üèñÔ∏è</span>Kindkto.</div>
                <div class="cat-btn" data-cat="DA" onclick="selectModalCat(this, 'DA', 'üèñÔ∏è', 'taken')"><span class="cat-btn-icon">üèñÔ∏è</span>DA</div>
                <div class="cat-btn" data-cat="Langzeitkonto" onclick="selectModalCat(this, 'Langzeitkonto', 'üèñÔ∏è', 'taken')"><span class="cat-btn-icon">üèñÔ∏è</span>LZK</div>
                <div class="cat-btn" data-cat="Sonderurlaub" onclick="selectModalCat(this, 'Sonderurlaub', 'üèñÔ∏è', 'taken')"><span class="cat-btn-icon">üèñÔ∏è</span>Sonder</div>
                
                <div class="cat-btn" data-cat="UvD" onclick="selectModalCat(this, 'UvD', 'üè†', 'note')"><span class="cat-btn-icon">üè†</span>UvD</div>
                <div class="cat-btn" data-cat="UvD Standort" onclick="selectModalCat(this, 'UvD Standort', 'üè†', 'note')"><span class="cat-btn-icon">üè†</span>UvD St.</div>
                <div class="cat-btn" data-cat="KvD" onclick="selectModalCat(this, 'KvD', 'üöò', 'note')"><span class="cat-btn-icon">üöò</span>KvD</div>
                <div class="cat-btn" data-cat="Ausbildung" onclick="selectModalCat(this, 'Ausbildung', 'üìö', 'note')"><span class="cat-btn-icon">üìö</span>Ausbildung</div>
                <div class="cat-btn" data-cat="Kindkrank" onclick="selectModalCat(this, 'Kindkrank', 'üå°Ô∏è', 'taken')"><span class="cat-btn-icon">üå°Ô∏è</span>Kindkrank</div>
                <div class="cat-btn" data-cat="Sonstiges" onclick="selectModalCat(this, 'Sonstiges', 'üìå', 'note')"><span class="cat-btn-icon">üìå</span>Sonstiges</div>
            </div>
            <div id="modal-selection-display" style="text-align:center; font-size:12px; color:var(--accent); margin-bottom:10px; font-weight:bold;">W√§hle eine Kategorie...</div>
            <div id="modal-hours-container" class="modal-input-group hidden" style="margin-bottom:10px;">
                <label style="font-size:9px;">Anzahl Stunden (Manuell)</label>
                <input type="number" id="modal-hours-input" step="0.1" placeholder="z.B. 8 oder 0">
            </div>
            <div class="modal-input-group" style="display:flex; gap:5px; margin-bottom:10px;">
                <div style="flex:1;"><label style="font-size:9px;">Start</label><input type="date" id="modal-date-start" style="width:100%; font-size:13px; padding:8px;"></div>
                <div style="flex:1;"><label style="font-size:9px;">Ende</label><input type="date" id="modal-date-end" style="width:100%; font-size:13px; padding:8px;"></div>
            </div>
            <div class="modal-input-group" style="display:flex; gap:5px; margin-bottom:10px;">
                <div style="flex:1;"><label style="font-size:9px;">Zeit Von</label><input type="time" id="modal-time-start" style="width:100%; font-size:13px; padding:8px;"></div>
                <div style="flex:1;"><label style="font-size:9px;">Zeit Bis</label><input type="time" id="modal-time-end" style="width:100%; font-size:13px; padding:8px;"></div>
            </div>
            <div class="modal-input-group" style="margin-bottom:10px;">
                <label style="font-size:9px;">Beschreibung / Notiz</label>
                <input type="text" id="modal-note-input" placeholder="Text hinzuf√ºgen..." style="width:100%;">
            </div>
            <button class="btn btn-primary" onclick="saveModalEntry()" style="padding:10px; font-size:14px;">Eintrag Speichern</button>
        </div>
    </div>

    <div id="settings-modal" class="modal-overlay" onclick="closeSettings(event)">
        <div class="modal-content">
            <div class="modal-header"><div class="modal-title">Einstellungen</div><button class="close-btn" onclick="document.getElementById('settings-modal').classList.remove('open')">√ó</button></div>
            
            <div style="margin-bottom:15px; font-weight:bold; color:var(--accent); font-size:14px;">Erinnerungen konfigurieren</div>
            <div id="reminders-config-container"></div>

            <div style="margin-top:20px; margin-bottom:15px; font-weight:bold; color:var(--accent); font-size:14px; border-top:1px solid #333; padding-top:10px;">Standard Arbeitszeiten</div>
            <table class="settings-table"><thead><tr><th>Tag</th><th>Von</th><th>Bis</th></tr></thead><tbody id="settings-tbody"></tbody></table>
            
            <button class="btn btn-primary" onclick="saveSettings()" style="margin-top:20px;">Speichern</button>
        </div>
    </div>

    <nav>
        <div class="nav-item active" onclick="showView('view-home', this, 'Start')">
            <span>üè†</span>
            <div>Start</div>
        </div>
        <div class="nav-item" onclick="showView('view-input', this, 'Buchen')">
            <span>‚ûï</span>
            <div>Buchen</div>
        </div>
        <div class="nav-item" onclick="showView('view-calendar', this, 'Kalender')">
            <span>üìÖ</span>
            <div>Kalender</div>
        </div>
        <div class="nav-item" onclick="showView('view-history', this, 'Verlauf')">
            <span>‚â°</span>
            <div>Verlauf</div>
        </div>
        <div class="nav-item" onclick="showView('view-stats', this, 'Statistik')">
            <span>üìä</span>
            <div>Statistik</div>
        </div>
    </nav>
    <script>
        let entries = JSON.parse(localStorage.getItem('trackData_v5')) || [];
        
        const defaultSettings = { 
            schedule: [{s:"00:00",e:"00:00"},{s:"07:00",e:"16:00"},{s:"07:00",e:"16:00"},{s:"07:00",e:"16:00"},{s:"07:00",e:"16:00"},{s:"07:00",e:"13:00"},{s:"00:00",e:"00:00"}],
            reminders: {
                uvd: { active: true, days: 1, label: "UvD/KvD (Danach)" },
                arzt: { active: true, days: 1, label: "Arzt (Danach)" },
                urlaub: { active: true, days: 14, label: "Urlaub/Antrag (Davor)" },
                stunden: { active: true, days: 5, label: "Std. Abbau (Davor)" },
                uebungsplatz: { active: true, days: 21, label: "√úbungsplatz (Danach)" }
            }
        };
        let settings = JSON.parse(localStorage.getItem('trackSettings_v17')) || defaultSettings;
        if(!settings.reminders) settings.reminders = defaultSettings.reminders;

        let mode = 'taken'; 
        let currentCalYear = new Date().getFullYear(); 
        let calendarFilter = 'all'; 
        let modalCurrentIsoDate = null; 
        let currentEditId = null; 
        let activeReminders = []; 
        let modalSelected = { cat: '', icon: '', type: '' };

        const CAT_CONFIG = {
            'Arzttermin': { icon: 'üíâ', type: 'note' },
            '√úbungsplatz': { icon: 'üîß', type: 'note' }, 
            '√úbungsplatz Gr√ºn': { icon: 'üå≥', type: 'note' }, 
            'Urlaub': { icon: 'üèñÔ∏è', type: 'taken' },
            'Kindkonto': { icon: 'üèñÔ∏è', type: 'taken' }, 
            'DA': { icon: 'üèñÔ∏è', type: 'taken' },
            'Langzeitkonto': { icon: 'üèñÔ∏è', type: 'taken' },
            'Sonderurlaub': { icon: 'üèñÔ∏è', type: 'taken' },
            'Stunden': { icon: '‚è∞', type: 'taken' },
            'UvD': { icon: 'üè†', type: 'note' },
            'UvD Standort': { icon: 'üè†', type: 'note' },
            'KvD': { icon: 'üöò', type: 'note' },
            'Ausbildung': { icon: 'üìö', type: 'note' },
            'Kindkrank': { icon: 'üå°Ô∏è', type: 'taken' },
            'Sonstiges': { icon: 'üìå', type: 'note' }
        };

        const DAY_NAMES = ["So", "Mo", "Di", "Mi", "Do", "Fr", "Sa"];

        function getThuringiaHolidayName(isoDate) {
            const year = parseInt(isoDate.split('-')[0]);
            const fixedHolidays = {
                [`${year}-01-01`]: "Neujahr", [`${year}-05-01`]: "Tag der Arbeit", [`${year}-09-20`]: "Weltkindertag",
                [`${year}-10-03`]: "Tag der Deutschen Einheit", [`${year}-10-31`]: "Reformationstag",
                [`${year}-12-25`]: "1. Weihnachtsfeiertag", [`${year}-12-26`]: "2. Weihnachtsfeiertag"
            };
            if(fixedHolidays[isoDate]) return "üéâ " + fixedHolidays[isoDate];
            const movable = {
                "2025": { "2025-04-18":"Karfreitag", "2025-04-21":"Ostermontag", "2025-05-29":"Christi Himmelfahrt", "2025-06-09":"Pfingstmontag" },
                "2026": { "2026-04-03":"Karfreitag", "2026-04-06":"Ostermontag", "2026-05-14":"Christi Himmelfahrt", "2026-05-25":"Pfingstmontag" },
                "2027": { "2027-03-26":"Karfreitag", "2027-03-29":"Ostermontag", "2027-05-06":"Christi Himmelfahrt", "2027-05-17":"Pfingstmontag" }
            };
            if(movable[year] && movable[year][isoDate]) return "‚úùÔ∏è " + movable[year][isoDate];
            const vacations = {
                "2025": [{s:"2025-02-03",e:"2025-02-08",n:"Winterferien"},{s:"2025-04-07",e:"2025-04-19",n:"Osterferien"},{s:"2025-05-30",e:"2025-05-30",n:"Ferientag n. Himmelfahrt"},{s:"2025-06-28",e:"2025-08-08",n:"Sommerferien"},{s:"2025-10-06",e:"2025-10-18",n:"Herbstferien"},{s:"2025-12-22",e:"2025-12-31",n:"Weihnachtsferien"}],
                "2026": [{s:"2026-01-01",e:"2026-01-03",n:"Weihnachtsferien"},{s:"2026-02-16",e:"2026-02-21",n:"Winterferien"},{s:"2026-04-07",e:"2026-04-17",n:"Osterferien"},{s:"2026-05-15",e:"2026-05-15",n:"Ferientag n. Himmelfahrt"},{s:"2026-07-04",e:"2026-08-14",n:"Sommerferien"},{s:"2026-10-12",e:"2026-10-24",n:"Herbstferien"},{s:"2026-12-23",e:"2026-12-31",n:"Weihnachtsferien"}],
                "2027": [{s:"2027-01-01",e:"2027-01-02",n:"Weihnachtsferien"},{s:"2027-02-01",e:"2027-02-06",n:"Winterferien"},{s:"2027-03-22",e:"2027-04-03",n:"Osterferien"},{s:"2027-05-07",e:"2027-05-07",n:"Ferientag n. Himmelfahrt"},{s:"2027-07-10",e:"2027-08-20",n:"Sommerferien"},{s:"2027-10-09",e:"2027-10-23",n:"Herbstferien"},{s:"2027-12-23",e:"2027-12-31",n:"Weihnachtsferien"}]
            };
            if(vacations[year]) {
                for(let v of vacations[year]) { if(isoDate >= v.s && isoDate <= v.e) { let icon="üè´"; if(v.n.includes("Weihnacht")) icon="üéÑ"; if(v.n.includes("Oster")) icon="üê∞"; if(v.n.includes("Sommer")) icon="‚òÄÔ∏è"; if(v.n.includes("Herbst")) icon="üçÇ"; if(v.n.includes("Winter")) icon="‚ùÑÔ∏è"; return icon+" "+v.n; } }
            }
            return null;
        }

        window.onload = function() {
            const today = new Date().toISOString().slice(0,10);
            ['date-start-time','date-end-time','modal-date-start','modal-date-end'].forEach(id => { if(document.getElementById(id)) document.getElementById(id).value = today; });
            updateUI();
            checkReminders(); 
        };

        function formatDateDE(isoDate) { if(!isoDate) return ""; const parts = isoDate.split('-'); return `${parts[2]}.${parts[1]}.${parts[0]}`; }
        function formatNumber(num) { return Number(num.toFixed(2)).toString(); }
        
        function toggleFilterMenu() { document.getElementById('filter-menu').classList.toggle('show'); }
        function applyFilter(f, label) {
            calendarFilter = f;
            document.getElementById('filter-btn-label').innerHTML = `Filter: ${label} <span>‚ñæ</span>`;
            document.getElementById('filter-menu').classList.remove('show');
            document.querySelectorAll('.filter-option').forEach(el => el.classList.remove('selected'));
            renderCalendar();
        }

        function checkReminders() {
            const today = new Date(); today.setHours(0,0,0,0);
            activeReminders = [];
            const cfg = settings.reminders; 

            entries.forEach(e => {
                if(e.reminderDismissed) return;
                const eventStart = new Date(e.isoStart); eventStart.setHours(0,0,0,0);
                const eventEnd = new Date(e.isoEnd || e.isoStart); eventEnd.setHours(0,0,0,0);
                const diffMs = eventStart - today; const daysUntil = Math.ceil(diffMs / (1000 * 60 * 60 * 24));
                const diffMsAfter = today - eventEnd; const daysSinceEnd = Math.floor(diffMsAfter / (1000 * 60 * 60 * 24));

                if (cfg.uvd.active && (e.cat === 'UvD' || e.cat === 'KvD' || e.cat === 'UvD Standort') && daysSinceEnd >= cfg.uvd.days) {
                    activeReminders.push({ id: e.id, text: `Stunden f√ºr ${e.cat} am ${e.date} nachtragen?`, icon: "‚è∞", date: e.date });
                }
                if (cfg.arzt.active && e.cat === 'Arzttermin' && daysSinceEnd >= cfg.arzt.days) {
                    activeReminders.push({ id: e.id, text: "Beim Arzt gewesen?\nNeuer Termin vereinbart?", icon: "üíâ", date: e.date });
                }
                if (cfg.urlaub.active && ['Urlaub','DA','Langzeitkonto','Sonderurlaub','Kindkonto'].includes(e.cat)) {
                    if (daysUntil <= cfg.urlaub.days && daysUntil > -5) { activeReminders.push({ id: e.id, text: `Antrag f√ºr ${e.cat} geschrieben?`, icon: "üìù", date: e.date }); }
                }
                if (cfg.stunden.active && e.cat === 'Stunden' && e.mode === 'taken') {
                    if (daysUntil <= cfg.stunden.days && daysUntil > -2) { activeReminders.push({ id: e.id, text: "Stundenabbau beantragt/geschrieben?", icon: "‚è≥", date: e.date }); }
                }
                if (cfg.uebungsplatz.active && (e.cat === '√úbungsplatz' || e.cat === '√úbungsplatz Gr√ºn') && daysSinceEnd >= cfg.uebungsplatz.days) {
                    activeReminders.push({ id: e.id, text: "Stunden oder DA daf√ºr erhalten?", icon: "üí∞", date: e.date });
                }
            });
            showNextReminder();
        }
        function showNextReminder() {
            if(activeReminders.length === 0) { document.getElementById('reminder-modal').classList.remove('open'); return; }
            const rem = activeReminders[0];
            document.getElementById('rem-icon').innerText = rem.icon; document.getElementById('rem-date').innerText = rem.date;
            document.getElementById('rem-text').innerText = rem.text; document.getElementById('reminder-modal').classList.add('open');
        }
        function handleReminder(isDone) {
            const current = activeReminders[0];
            if (isDone) { const idx = entries.findIndex(e => e.id === current.id); if(idx !== -1) { entries[idx].reminderDismissed = true; localStorage.setItem('trackData_v5', JSON.stringify(entries)); } }
            activeReminders.shift(); showNextReminder();
        }

        function saveEntry() {
            const cat = 'Stunden'; const mode = 'earned';
            const ds = document.getElementById('date-start-time').value; const de = document.getElementById('date-end-time').value; const note = document.getElementById('inp-note').value;
            if(!ds) { alert('Datum fehlt'); return; } if(!de) { document.getElementById('date-end-time').value = ds; }
            let manualH = document.getElementById('hours-manual-val').value; if(manualH === "") { alert('Bitte Stunden eingeben'); return; }
            let hoursVal = parseFloat(manualH);
            let dispDate = (ds===de || !de) ? formatDateDE(ds) : `${formatDateDE(ds)} - ${formatDateDE(de)}`; 
            let dispTime = `${document.getElementById('time-start').value} - ${document.getElementById('time-end').value}`; 
            if(currentEditId) { entries = entries.filter(e => e.id !== currentEditId); currentEditId = null; document.getElementById('btn-save-main').innerText = "Buchen"; document.getElementById('edit-mode-hint').style.display = 'none'; }
            entries.unshift({ id: Date.now(), cat: cat, date: dispDate, isoStart: ds, isoEnd: de || ds, timeDesc: dispTime, hours: hoursVal, mode: mode, note: note, color: null, icon: '‚ûï' });
            localStorage.setItem('trackData_v5', JSON.stringify(entries)); alert('Gespeichert'); updateUI();
            document.getElementById('hours-manual-val').value = ""; document.getElementById('inp-note').value = "";
        }
        function editEntry(id) {
            const e = entries.find(x => x.id === id); if(!e) return;
            if(e.cat === 'Stunden' && e.mode === 'earned') {
                showView('view-input', document.querySelectorAll('.nav-item')[1], 'Buchen'); // Index 1 ist Buchen
                document.getElementById('date-start-time').value = e.isoStart; document.getElementById('date-end-time').value = e.isoEnd;
                const times = e.timeDesc.match(/(\d{2}:\d{2})/g); if(times && times.length >= 2) { document.getElementById('time-start').value = times[0]; document.getElementById('time-end').value = times[1]; }
                document.getElementById('hours-manual-val').value = e.hours; document.getElementById('inp-note').value = e.note || "";
                currentEditId = id; document.getElementById('btn-save-main').innerText = "√Ñnderung speichern"; document.getElementById('edit-mode-hint').style.display = 'block'; return;
            }
             closeListView({target:{id:'list-view-modal'}}); showView('view-calendar', document.querySelectorAll('.nav-item')[2], 'Kalender'); modalCurrentIsoDate = e.isoStart; openModal(e.isoStart, getEventsForDate(e.isoStart));
             setTimeout(() => {
                 document.getElementById('modal-date-start').value = e.isoStart; document.getElementById('modal-date-end').value = e.isoEnd;
                 const times = e.timeDesc.match(/(\d{2}:\d{2})/g); if(times && times.length >= 1) document.getElementById('modal-time-start').value = times[0]; if(times && times.length >= 2) document.getElementById('modal-time-end').value = times[1];
                 document.getElementById('modal-note-input').value = e.note || "";
                 if(e.cat === 'Stunden') { document.getElementById('modal-hours-input').value = e.hours; document.getElementById('modal-hours-container').classList.remove('hidden'); }
                 let btn = document.querySelector(`.cat-btn[data-cat="${e.cat}"]`); if(btn) btn.click(); currentEditId = id; 
             }, 200);
        }
        function deleteEntry(id) { if(confirm("L√∂schen?")) { entries = entries.filter(e => e.id !== id); localStorage.setItem('trackData_v5', JSON.stringify(entries)); updateUI(); if(document.getElementById('day-modal').classList.contains('open')) { const evs = getEventsForDate(modalCurrentIsoDate); openModal(modalCurrentIsoDate, evs); } } }
        
        function updateUI() { renderHistory(); renderStats(); renderCalendar(); renderHome(); }
        function ensureIsoDates(e) { if(e.isoStart) return; }

        function renderHistory() {
            const list = document.getElementById('history-list'); list.innerHTML = '';
            if(entries.length === 0) document.getElementById('no-data-msg').style.display = 'block'; else document.getElementById('no-data-msg').style.display = 'none';
            entries.forEach(e => {
                let colorClass = ''; let customStyle = '';
                if(e.cat.startsWith('Urlaub')) colorClass = 'cat-urlaub'; else if(e.cat.startsWith('Stunden')) colorClass = 'cat-stunden'; else if(e.cat.startsWith('Kind')) colorClass = 'cat-krank'; else if(e.cat.startsWith('DA')) colorClass = 'cat-da'; else if(e.cat.startsWith('Lang')) colorClass = 'cat-lzk'; else if(e.cat.startsWith('Sonder')) colorClass = 'cat-sonder'; else customStyle='border-left: 4px solid #555;';
                let valClass = e.mode === 'taken' ? 'neg' : 'pos'; let sign = e.mode === 'taken' ? '-' : '+'; let displayVal = "";
                if(e.hours > 0 || (e.hours === 0 && e.cat === 'Stunden')) { if (['Urlaub','Kindkrank','DA','Sonderurlaub','Kindkonto'].includes(e.cat)) displayVal = formatNumber(e.hours / 8) + " d"; else displayVal = formatNumber(e.hours) + " h"; } else { displayVal = ""; sign = ""; }
                let note = e.note ? `<div style="font-size:12px;color:#aaa;font-style:italic;">${e.note}</div>` : '';
                list.innerHTML += `<div class="history-item ${colorClass}" style="${customStyle}"><div class="h-content"><div class="h-top"><div><div class="h-title">${e.cat}</div><div class="h-meta">${e.date} | ${e.timeDesc}</div>${note}</div><div class="h-val ${valClass}">${sign} ${displayVal}</div></div></div><div class="h-btn-group"><button class="h-action-btn" onclick="editEntry(${e.id})">‚úé</button><button class="h-action-btn" onclick="deleteEntry(${e.id})" style="color:#FF453A;">üóëÔ∏è</button></div></div>`;
            });
        }
        
        // --- NEU: HILFSFUNKTION F√úR ZUK√úNFTIGE TERMINE (MIT UHRZEIT) ---
        function getStrictUpcomingEvents() {
            const now = new Date();
            const todayStr = now.toISOString().slice(0,10);
            const nowTimeStr = now.toTimeString().slice(0,5);

            return entries.filter(e => { 
                if(!e.isoStart) return false;
                
                // Filter: Keine Plus-Stunden
                if(e.mode === 'earned') return false; 
                if(e.cat === 'Stunden' && e.hours > 0 && e.mode !== 'taken') return false; 

                // Zeit-Logik
                if (e.isoStart > todayStr) return true; // Zukunft
                if (e.isoStart < todayStr) return false; // Vergangenheit
                
                // Wenn heute: Pr√ºfe Uhrzeit
                // Hole Startzeit aus timeDesc (z.B. "14:00 - ...")
                let startT = "23:59"; // Fallback: Wenn keine Zeit, zeige es heute noch an (Ganzt√§gig)
                const m = e.timeDesc.match(/(\d{2}:\d{2})/);
                if (m) { startT = m[1]; }
                else if (e.timeDesc.includes("Ganzt√§gig")) { startT = "23:59"; } // Ganzt√§gig gilt bis Ende des Tages

                // Wenn Terminzeit < Jetztzeit => Vorbei
                return startT >= nowTimeStr;
            }).sort((a, b) => {
                if (a.isoStart !== b.isoStart) { return a.isoStart.localeCompare(b.isoStart); }
                let tA = (a.timeDesc && a.timeDesc.match(/(\d{2}:\d{2})/)) ? a.timeDesc.match(/(\d{2}:\d{2})/)[0] : "00:00";
                let tB = (b.timeDesc && b.timeDesc.match(/(\d{2}:\d{2})/)) ? b.timeDesc.match(/(\d{2}:\d{2})/)[0] : "00:00";
                return tA.localeCompare(tB);
            });
        }

        function renderStats() {
            const grid = document.getElementById('stats-grid'); grid.innerHTML = '';
            let tDays = 0, tHours = 0;
            entries.forEach(e => { let v = (e.mode==='taken') ? -e.hours : e.hours; if(['Urlaub','DA','Sonderurlaub','Kindkonto'].includes(e.cat)) tDays += v; else if(['Stunden','Langzeitkonto'].includes(e.cat)) tHours += v; });
            grid.innerHTML += `<div class="stat-box summary"><div><h4>‚àë Tage</h4><span style="color:${tDays>=0?'#fff':'#ff453a'}">${formatNumber(tDays/8)}<span class="unit">Ges</span></span></div><div><h4>‚àë Stunden</h4><span style="color:${tHours>=0?'#fff':'#ff453a'}">${formatNumber(tHours)}<span class="unit">Ges</span></span></div></div>`;
            
            [{n:'Urlaub',u:'Tage'},{n:'Stunden',u:'Std'},{n:'Kindkonto',u:'Std'},{n:'Kindkrank',u:'Tage'},{n:'DA',u:'Tage'},{n:'Langzeitkonto',u:'Std'},{n:'Sonderurlaub',u:'Tage'}].forEach(c => {
                 let s = 0; entries.filter(x=>x.cat===c.n).forEach(x => s += (x.mode==='earned'?x.hours:-x.hours)); let d = (c.u==='Tage') ? s/8 : s;
                 let bx = document.createElement('div'); bx.className='stat-box'; bx.innerHTML = `<div class="edit-icon">‚úé</div><h4>${c.n}</h4><span style="color:${d>=0?'#fff':'#ff453a'}">${formatNumber(d)}<span class="unit">${c.u}</span></span>`; bx.onclick = () => adjustStat(c.n, s, c.u); grid.appendChild(bx);
            });
            
            // VERWENDUNG DER NEUEN FUNKTION F√úR STATISTIK
            const upcoming = getStrictUpcomingEvents();
            const top5 = upcoming.slice(0, 5);
            
            let listHtml = top5.length ? '' : '<div style="font-size:11px; color:#666;">Keine Termine</div>';
            top5.forEach(u => {
                let icon = '';
                if(u.cat === 'Stunden') { icon = (u.mode==='earned')?'‚ûï':'‚è∞'; } else if(u.icon) icon = u.icon; else if(CAT_CONFIG[u.cat]) icon=CAT_CONFIG[u.cat].icon; else icon='‚Ä¢';
                let noteHtml = u.note ? `<div style="font-size:10px; color:#aaa; overflow:hidden; white-space:nowrap; text-overflow:ellipsis;">${u.note}</div>` : '';
                listHtml += `<div class="upcoming-item" style="padding:6px 10px; margin-bottom:4px; display:block;"><div style="display:flex; justify-content:space-between; align-items:center;"><span style="display:flex; align-items:center;"><span class="u-icon" style="font-size:12px; width:15px;">${icon}</span><span style="font-size:12px;">${u.cat}</span></span><span style="font-size:11px; color:#888;">${formatDateDE(u.isoStart).slice(0,6)}</span></div>${noteHtml}</div>`;
            });
            let upBox = document.createElement('div'); upBox.className = 'stat-box full-width'; upBox.innerHTML = `<h4>N√§chste Termine</h4>${listHtml}`; grid.appendChild(upBox);
        }

        // --- NEU: RENDER HOME (STARTSEITE) ---
        function renderHome() {
            const container = document.getElementById('dash-next-content');
            const upcoming = getStrictUpcomingEvents();

            if (upcoming.length === 0) {
                container.innerHTML = '<div class="dash-empty">Alles erledigt! üéâ<br><span style="font-size:12px; color:#888;">Keine anstehenden Termine.</span></div>';
                return;
            }

            const next = upcoming[0]; // Das allererste Event
            let icon = next.icon || (CAT_CONFIG[next.cat] ? CAT_CONFIG[next.cat].icon : 'üìÖ');
            if(next.cat === 'Stunden' && next.mode === 'taken') icon = '‚è∞';

            container.innerHTML = `
                <div style="font-size:40px; margin-bottom:10px;">${icon}</div>
                <div class="dash-title">${next.cat}</div>
                <div class="dash-date">${formatDateDE(next.isoStart)}</div>
                <div class="dash-time">${next.timeDesc}</div>
                ${next.note ? `<div class="dash-note">${next.note}</div>` : ''}
            `;
        }

        function adjustStat(name, curr, unit) {
             let n = prompt(`Neuer Stand f√ºr ${name} (${unit}):`); if(n===null) return; let val = parseFloat(n.replace(',','.')); if(isNaN(val)) return;
             let diff = (unit==='Tage' ? val*8 : val) - curr; if(diff===0) return;
             entries.unshift({ id:Date.now(), cat:name, date:formatDateDE(new Date().toISOString().slice(0,10)), isoStart:new Date().toISOString().slice(0,10), isoEnd:new Date().toISOString().slice(0,10), timeDesc:"Korrektur", hours:Math.abs(diff), mode:diff>0?'earned':'taken', note:"Manuelle Korrektur Statistik" });
             localStorage.setItem('trackData_v5', JSON.stringify(entries)); updateUI();
        }

        function renderCalendar() {
            document.getElementById('calendar-year-display').innerText = currentCalYear; const root = document.getElementById('calendar-root'); root.innerHTML = ''; 
            const now = new Date();
            const realTodayDate = now.getDate();
            const realTodayMonth = now.getMonth();
            const realTodayYear = now.getFullYear();

            for (let i = 0; i < 12; i++) {
                const md = document.createElement('div'); md.className = 'month-card'; if(currentCalYear === now.getFullYear() && i === now.getMonth()) md.id = 'current-month-card';
                md.innerHTML = `<div class="month-name">${["Jan","Feb","M√§r","Apr","Mai","Jun","Jul","Aug","Sep","Okt","Nov","Dez"][i]}</div>`;
                const dg = document.createElement('div'); dg.className = 'days-grid'; ["M","D","M","D","F","S","S"].forEach(t => dg.innerHTML+=`<div class="day-label">${t}</div>`);
                const first = new Date(currentCalYear, i, 1).getDay(); const days = new Date(currentCalYear, i+1, 0).getDate();
                for(let j=0; j<(first===0?6:first-1); j++) dg.innerHTML+=`<div class="day-cell empty"></div>`;
                for(let d=1; d<=days; d++) {
                    const iso = `${currentCalYear}-${(i+1).toString().padStart(2,'0')}-${d.toString().padStart(2,'0')}`;
                    const evs = getEventsForDate(iso); 
                    const cell = document.createElement('div'); cell.className = 'day-cell';
                    
                    if (currentCalYear === realTodayYear && i === realTodayMonth && d === realTodayDate) {
                        cell.classList.add('is-today');
                    }

                    const holidayName = getThuringiaHolidayName(iso);
                    if(holidayName) { cell.classList.add('is-holiday'); }
                    if(evs.length) cell.classList.add('has-event');
                    let dots = ''; let limit = 4; let showEvs = evs.slice(0, limit);
                    showEvs.forEach(e => {
                        let icon = e.icon; 
                        if(e.cat === 'Stunden') { if(e.mode === 'earned') icon = '‚ûï'; else icon = '‚è∞'; } else if(!icon && CAT_CONFIG[e.cat]) icon = CAT_CONFIG[e.cat].icon;
                        if(icon) dots += `<span class="event-icon">${icon}</span>`; else { let c = '#555'; dots += `<div class="event-dot" style="background:${c}"></div>`; }
                    });
                    if(evs.length > limit) dots += `<span style="font-size:8px; line-height:1;">+</span>`;
                    cell.innerHTML = `<span>${d}</span><div class="event-dots">${dots}</div>`; cell.onclick = () => openModal(iso, evs); dg.appendChild(cell);
                } md.appendChild(dg); root.appendChild(md);
            }
            
            setTimeout(() => {
                const todayEl = document.querySelector('.is-today');
                if(todayEl) todayEl.scrollIntoView({behavior: "smooth", block: "center"});
            }, 500);
        }
        function changeYear(d) { currentCalYear += d; renderCalendar(); }
        
        function getEventsForDate(iso) {
            return entries.filter(e => {
                ensureIsoDates(e); if(!e.isoStart) return false;
                let inRange = (iso >= e.isoStart && iso <= e.isoEnd);
                if(!inRange) return false;
                if(calendarFilter==='all') return true;
                if(calendarFilter === 'Holiday') return false; 
                if(calendarFilter==='Dienst') { return ['UvD','KvD','UvD Standort','√úbungsplatz','√úbungsplatz Gr√ºn'].includes(e.cat); } 
                if(calendarFilter==='StundenTaken') return e.cat === 'Stunden' && e.mode === 'taken';
                if(calendarFilter==='StundenEarned') return e.cat === 'Stunden' && e.mode === 'earned';
                if(['Urlaub','Arzttermin','Ausbildung','√úbungsplatz','√úbungsplatz Gr√ºn','UvD','UvD Standort','KvD','DA','Langzeitkonto','Sonderurlaub','Kindkrank','Sonstiges','Kindkonto'].includes(calendarFilter)) {
                    return e.cat === calendarFilter;
                }
                return true;
            });
        }
        function getTimeFromEntry(e) { let m = e.timeDesc.match(/(\d{2}:\d{2})/); return m ? m[1] : "00:00"; }
        
        function openListModal() {
            const list = document.getElementById('list-view-body'); list.innerHTML = '';
            const sub = document.getElementById('list-view-subtitle');
            
            let filterFunc = (e) => true;
            let titleText = "Alle kommenden Eintr√§ge";

            if(calendarFilter === 'Dienst') {
                filterFunc = (e) => ['UvD','KvD','UvD Standort','√úbungsplatz','√úbungsplatz Gr√ºn'].includes(e.cat);
                titleText = "Kommende Dienste";
            } else if (calendarFilter === 'Urlaub') {
                filterFunc = (e) => ['Urlaub','Stunden'].includes(e.cat) && e.mode === 'taken';
                titleText = "Geplanter Urlaub / Stundenabbau";
            } else if (calendarFilter !== 'all' && calendarFilter !== 'Holiday') {
                filterFunc = (e) => e.cat === calendarFilter;
                titleText = `Kommende: ${calendarFilter}`;
            }

            sub.innerText = titleText;

            // VERWENDUNG DER NEUEN FILTER LOGIK AUCH HIER
            const filtered = getStrictUpcomingEvents().filter(filterFunc);

            if(!filtered.length) list.innerHTML = '<div style="text-align:center;padding:20px;color:#666">Keine Eintr√§ge gefunden</div>';
            filtered.forEach(e => {
                 if(e.note==="Manuelle Korrektur Statistik") return;
                 let icon = ''; if(e.cat==='Stunden') icon = e.mode==='earned'?'‚ûï':'‚è∞'; else icon = e.icon || (CAT_CONFIG[e.cat]?CAT_CONFIG[e.cat].icon:'‚Ä¢');
                 let desc = e.cat; let sub = `${e.date} | ${e.timeDesc}`;
                 list.innerHTML += `<div class="list-view-item future"><div class="lv-icon">${icon}</div><div class="lv-info" onclick="jumpToDate('${e.isoStart}')"><div class="lv-title">${desc}</div><div class="lv-meta">${sub}</div></div><button class="h-action-btn" onclick="editEntry(${e.id})">‚úé</button></div>`;
            });
            document.getElementById('list-view-modal').classList.add('open');
        }
        function closeListView(e) { if(e.target.id==='list-view-modal') document.getElementById('list-view-modal').classList.remove('open'); }
        
        function openModal(iso, events) {
            modalCurrentIsoDate = iso; currentEditId = null; 
            document.getElementById('modal-date-title').innerText = formatDateDE(iso);
            const body = document.getElementById('modal-body'); body.innerHTML = '';
            
            const holidayName = getThuringiaHolidayName(iso);
            if(holidayName) {
                 body.innerHTML += `<div style="text-align:center; margin-bottom:10px; color:#30D158; font-weight:bold; font-size:15px; border-bottom:1px solid #333; padding-bottom:5px;">${holidayName}</div>`;
            }

            if(!events.length) body.innerHTML += '<div style="text-align:center;padding:5px;color:#666;font-size:12px;">Keine Eintr√§ge an diesem Tag</div>';
            events.forEach(e => {
                let col = '#fff'; let displayIcon = e.icon;
                if(e.cat === 'Stunden') { if(e.mode === 'earned') displayIcon = '‚ûï'; else displayIcon = '‚è∞'; col = 'var(--c-stunden)'; }
                else if(['Urlaub','DA','Kindkrank','Sonderurlaub','Kindkonto'].includes(e.cat)) col = 'var(--c-urlaub)';
                else if(['Langzeitkonto'].includes(e.cat)) col = 'var(--c-lzk)';
                body.innerHTML += `<div style="display:flex; justify-content:space-between; margin-bottom:8px; border-bottom:1px solid #333; padding-bottom:5px;"><div><div style="font-weight:bold; color:${col}; font-size:14px;">${displayIcon} ${e.cat}</div><div style="font-size:12px; color:#aaa">${e.timeDesc}</div>${e.note ? `<div style="font-size:11px;color:#888;font-style:italic;">${e.note}</div>` : ''}</div><div style="display:flex; gap:10px;"><button style="background:none; border:none; font-size:16px; cursor:pointer;" onclick="editEntry(${e.id})">‚úé</button><button style="background:none; border:none; color:#ff453a; font-size:16px; cursor:pointer;" onclick="deleteEntry(${e.id})">üóëÔ∏è</button></div></div>`;
            });
            document.getElementById('modal-date-start').value = iso; document.getElementById('modal-date-end').value = iso;
            document.getElementById('modal-time-start').value = ""; document.getElementById('modal-time-end').value = ""; 
            document.getElementById('modal-note-input').value = ""; document.getElementById('modal-hours-input').value = "";
            document.getElementById('modal-hours-container').classList.add('hidden');
            document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('modal-selection-display').innerText = "W√§hle eine Kategorie...";
            modalSelected = { cat: '', icon: '', type: '' };
            document.getElementById('day-modal').classList.add('open');
        }

        function selectModalCat(btn, cat, icon, type) {
            modalSelected = { cat, icon, type };
            document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            if(cat === 'Stunden') { document.getElementById('modal-hours-container').classList.remove('hidden'); } else { document.getElementById('modal-hours-container').classList.add('hidden'); }
            document.getElementById('modal-selection-display').innerText = cat;
        }

        function saveModalEntry() {
            if(!modalSelected.cat) { alert('Bitte Kategorie w√§hlen'); return; }
            const ds = document.getElementById('modal-date-start').value; const de = document.getElementById('modal-date-end').value;
            const ts = document.getElementById('modal-time-start').value; const te = document.getElementById('modal-time-end').value;
            const note = document.getElementById('modal-note-input').value;
            if(!ds || !de) { alert('Datum fehlt'); return; }
            let td = ""; if(ts && te) td = `${ts} - ${te} Uhr`; else if(ts) td = `${ts} Uhr`; if (ds !== de) td += (td ? " " : "") + `(bis ${formatDateDE(de)})`; if(!td) td = "Ganzt√§gig";
            let hours = 0;
            if(modalSelected.type === 'taken') {
                if(modalSelected.cat === 'Stunden') { let manualH = document.getElementById('modal-hours-input').value; if(manualH !== "") { hours = parseFloat(manualH); } else { hours = 0; } } 
                else { let count = 0, curr = new Date(ds), end = new Date(de); while (curr <= end) { if (curr.getDay() !== 0 && curr.getDay() !== 6) count++; curr.setDate(curr.getDate() + 1); } hours = count * 8; }
            }
            if(currentEditId) { entries = entries.filter(e => e.id !== currentEditId); currentEditId = null; }
            entries.unshift({ id: Date.now(), cat: modalSelected.cat, date: (ds===de) ? formatDateDE(ds) : `${formatDateDE(ds)} - ${formatDateDE(de)}`, isoStart: ds, isoEnd: de, timeDesc: td, hours: hours, mode: modalSelected.type, note: note, color: null, icon: modalSelected.icon });
            localStorage.setItem('trackData_v5', JSON.stringify(entries)); openModal(modalCurrentIsoDate, getEventsForDate(modalCurrentIsoDate)); updateUI();
        }

        function closeModalDirect() { document.getElementById('day-modal').classList.remove('open'); }
        function closeModal(e) { if(e.target.id==='day-modal') closeModalDirect(); }
        function jumpToDate(iso) { closeListView({target:{id:'list-view-modal'}}); showView('view-calendar',document.querySelectorAll('.nav-item')[2],'Kalender'); openModal(iso, getEventsForDate(iso)); }
        
        function showView(id,el,ti) {
            document.querySelectorAll('.view').forEach(v=>v.classList.remove('active')); document.getElementById(id).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active')); if(el) el.classList.add('active');
            document.getElementById('header-title').innerText = ti;
            const resetBtn = document.getElementById('header-reset-btn');
            if(id === 'view-stats') { resetBtn.style.display = 'block'; } else { resetBtn.style.display = 'none'; }
            if(id==='view-calendar') setTimeout(()=>{const c=document.getElementById('current-month-card'); if(c) c.scrollIntoView({behavior:"smooth",block:"center"});},100);
        }
        function resetAll() { if(confirm("ALLES L√ñSCHEN? Reset?")) { localStorage.removeItem('trackData_v5'); entries=[]; updateUI(); } }
        
        function openSettings() { 
            document.getElementById('settings-modal').classList.add('open'); 
            const rc = document.getElementById('reminders-config-container');
            rc.innerHTML = '';
            for(const [key, cfg] of Object.entries(settings.reminders)) {
                let daysVal = cfg.days;
                let active = cfg.active ? 'checked' : '';
                let html = `<div class="rem-config-row"><div class="rem-config-label">${cfg.label}</div><div class="rem-config-inputs"><input type="number" class="rem-days-input" id="rem-days-${key}" value="${daysVal}" min="0"><span style="font-size:11px;color:#888;">Tage</span><label class="toggle-switch"><input type="checkbox" id="rem-active-${key}" ${active}><span class="slider"></span></label></div></div>`;
                rc.innerHTML += html;
            }
            const tb=document.getElementById('settings-tbody'); tb.innerHTML=''; 
            [1,2,3,4,5,6,0].forEach(i=>{ let s=settings.schedule[i]; tb.innerHTML+=`<tr><td>${DAY_NAMES[i]}</td><td><input type="time" id="set-s-${i}" value="${s.s}"></td><td><input type="time" id="set-e-${i}" value="${s.e}"></td></tr>`; }); 
        }

        function saveSettings() { 
            for(const key of Object.keys(settings.reminders)) {
                const d = parseInt(document.getElementById(`rem-days-${key}`).value);
                const a = document.getElementById(`rem-active-${key}`).checked;
                settings.reminders[key].days = isNaN(d) ? settings.reminders[key].days : d;
                settings.reminders[key].active = a;
            }
            for(let i=0;i<7;i++){ settings.schedule[i]={s:document.getElementById(`set-s-${i}`).value, e:document.getElementById(`set-e-${i}`).value}; } 
            localStorage.setItem('trackSettings_v17', JSON.stringify(settings)); 
            document.getElementById('settings-modal').classList.remove('open'); 
            checkReminders(); updateUI(); 
        }
        function exportData() { const b=new Blob([JSON.stringify({entries,settings})],{type:"application/json"}); const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download="backup_v57.json"; a.click(); }
        function importData(inp) { const r=new FileReader(); r.onload=e=>{ let d=JSON.parse(e.target.result); if(Array.isArray(d)) entries=d; else { entries=d.entries; settings=d.settings; } localStorage.setItem('trackData_v5', JSON.stringify(entries)); updateUI(); }; r.readAsText(inp.files[0]); }
    </script>
</body>
</html>
